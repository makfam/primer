<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Maps | Preceptor’s Primer for Bayesian Big Data Science</title>
<meta name="author" content="David Kane">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.5.3/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.2/htmlwidgets.js"></script><script src="libs/plotly-binding-4.9.2.1/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.0.1/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css-1.52.2/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-1.52.2/plotly-latest.min.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Preceptor’s Primer for Bayesian Big Data Science</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preamble.html">Preamble</a></li>
<li><a class="" href="shopping-week.html">Shopping Week</a></li>
<li><a class="" href="visualization.html"><span class="header-section-number">1</span> Visualization</a></li>
<li><a class="" href="wrangling.html"><span class="header-section-number">2</span> Wrangling</a></li>
<li><a class="" href="functions.html"><span class="header-section-number">3</span> Functions</a></li>
<li><a class="" href="rubin-causal-model.html"><span class="header-section-number">4</span> Rubin Causal Model</a></li>
<li><a class="" href="probability.html"><span class="header-section-number">5</span> Probability</a></li>
<li><a class="" href="one-parameter.html"><span class="header-section-number">6</span> One Parameter</a></li>
<li><a class="" href="two-parameters.html"><span class="header-section-number">7</span> Two Parameters</a></li>
<li><a class="" href="three-parameters.html"><span class="header-section-number">8</span> Three Parameters</a></li>
<li><a class="" href="four-parameters.html"><span class="header-section-number">9</span> Four Parameters</a></li>
<li><a class="" href="five-parameters.html"><span class="header-section-number">10</span> Five Parameters</a></li>
<li><a class="" href="n-parameters.html"><span class="header-section-number">11</span> N Parameters</a></li>
<li><a class="" href="case-studies.html"><span class="header-section-number">12</span> Case Studies</a></li>
<li><a class="" href="tools.html">Tools</a></li>
<li><a class="" href="shiny.html">Shiny</a></li>
<li><a class="active" href="maps.html">Maps</a></li>
<li><a class="" href="animation.html">Animation</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/PPBDS/primer">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="maps" class="section level1 unnumbered">
<h1>Maps<a class="anchor" aria-label="anchor" href="#maps"><i class="fas fa-link"></i></a>
</h1>
<!-- Put example in from Blackwell's slavery work. Need to add relevant data to PPBDS.data first. -->
<!-- Add something about street maps? http://joshuamccrain.com/tutorials/maps/streets_tutorial.html -->
<!-- Change footnotes to proper sidemargin notes. -->
<p>In order to make maps, we first need some data.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;This section remixes some material from &lt;a href="https://github.com/andrewbtran/NICAR-2019-mapping" class="uri"&gt;https://github.com/andrewbtran/NICAR-2019-mapping&lt;/a&gt; by Andrew Tran.&lt;/p&gt;'><sup>6</sup></a></p>
<div id="tidycensus" class="section level2 unnumbered">
<h2>Tidycensus<a class="anchor" aria-label="anchor" href="#tidycensus"><i class="fas fa-link"></i></a>
</h2>
<p>The <strong>tidycensus</strong> package is a great way to load interesting data for mapping. Note that to use this package, <strong>you’ll need a Census API key.</strong> You can request a key <a href="https://api.census.gov/data/key_signup.html">here</a>. Once you have a key, you’ll need the following two commands to use the package:</p>
<div class="sourceCode" id="cb802"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/walkerke/tidycensus">tidycensus</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/census_api_key.html">census_api_key</a></span><span class="op">(</span><span class="st">"API KEY"</span><span class="op">)</span></code></pre></div>
<!-- AR: For this code to work, you have to have an actual API key in here. So we don't have to worry about keys expiring, etc., I've saved the RDS files and will load them in the script. -->
<p>where <code>"API KEY"</code> is replaced with your API key.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;If you run the &lt;code&gt;census_api_key()&lt;/code&gt; function with the option &lt;code&gt;install = TRUE&lt;/code&gt;, it will save your API key in your &lt;code&gt;.Renviron&lt;/code&gt; so you don’t have to run &lt;code&gt;census_api_key()&lt;/code&gt; every time you want to get data from the Census. However, you should only do this once.&lt;/p&gt;"><sup>7</sup></a></p>
<p>How can we retrieve each state’s population from the 2010 Census? To get data from the decennial census, you can use the function <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code>.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;You can also get data from the American Community Survey using the &lt;strong&gt;tidycensus&lt;/strong&gt; package, using the similar &lt;code&gt;get_acs()&lt;/code&gt; function.&lt;/p&gt;"><sup>8</sup></a> It only takes three arguments to get the data we want:</p>
<ul>
<li>
<code>geography</code> determines the unit of analysis. Here, we use “state,” but there are many other <a href="https://walkerke.github.io/tidycensus/articles/basic-usage.html#geography-in-tidycensus">geographies</a> you could use, such as “us” for the entire country, “county” for counties, and so on.</li>
<li>
<code>variables</code> selects which Census variables you want. Unfortunately, they have rather opaque names. If you didn’t know that “P001001” was the variable name for population, you have a couple of options:
<ul>
<li>Use the <code><a href="https://rdrr.io/pkg/tidycensus/man/load_variables.html">load_variables()</a></code> function in <strong>tidycensus</strong> to generate a tibble of variable names (described <a href="https://walkerke.github.io/tidycensus/articles/basic-usage.html#searching-for-variables">here</a>).</li>
<li>Search on <a href="https://data.census.gov">data.census.gov</a> for the variable you want and download the results of the search; the variable name will be in the .csv file.</li>
</ul>
</li>
<li>
<code>year</code> is the year. <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code> can obtain data from the 1990, 2000, and 2010 Census.</li>
</ul>
<div class="sourceCode" id="cb803"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial</a></span><span class="op">(</span>geography <span class="op">=</span> <span class="st">"state"</span>,
                     variables <span class="op">=</span> <span class="st">"P001001"</span>,
                     year <span class="op">=</span> <span class="fl">2010</span><span class="op">)</span>

<span class="fu">glimpse</span><span class="op">(</span><span class="va">pop</span><span class="op">)</span></code></pre></div>
<pre><code>## Rows: 52
## Columns: 4
## $ GEOID    &lt;chr&gt; "01", "02", "04", "05", "06", "22", "21", "08", "09", "10", …
## $ NAME     &lt;chr&gt; "Alabama", "Alaska", "Arizona", "Arkansas", "California", "L…
## $ variable &lt;chr&gt; "P001001", "P001001", "P001001", "P001001", "P001001", "P001…
## $ value    &lt;dbl&gt; 4.8e+06, 7.1e+05, 6.4e+06, 2.9e+06, 3.7e+07, 4.5e+06, 4.3e+0…</code></pre>
<p>The output is a tibble with four columns:</p>
<ul>
<li>
<code>GEOID</code> is part of the FIPS code, which is short for Federal Information Processing Standard. It’s a standardized way to identify states, counties, census tracts, etc. In this instance it’s only two digits wide. The more specific you get into the Census boundaries, the longer the number gets.</li>
<li>
<code>NAME</code> is the generic name <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code> gives to the unit you selected with <code>geography</code>; here, they are state names. Note that there are 52 observations; the “state” geography includes D.C. and Puerto Rico along with the 50 states.</li>
<li>
<code>variable</code> is the name of the variable you selected.</li>
<li>
<code>value</code> is the value of the variable you selected (here, population).</li>
</ul>
<p>What if you wanted to select more than one variable? By default, <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code> will stack all the variables on top of each other, identifying them with the <code>variable</code> column. So let’s say that you wanted to know the proportion of the population of each state that lives in rural areas. You would select two variables (total population and rural population) and would receive a tibble with 104 observations, with each state appearing once per variable. This may not be the most helpful way to receive the data, depending on your purposes. (When faceting, you may want the data in a long format like this, as we’ll see below.) You can request the data in wide format instead by using the option <code>output = "wide"</code>.</p>
<div class="sourceCode" id="cb805"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial</a></span><span class="op">(</span>geography <span class="op">=</span> <span class="st">"state"</span>,
                       variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"P001001"</span>, <span class="st">"P002005"</span><span class="op">)</span>,
                       year <span class="op">=</span> <span class="fl">2010</span>,
                       output <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span>
<span class="fu">glimpse</span><span class="op">(</span><span class="va">rural</span><span class="op">)</span></code></pre></div>
<pre><code>## Rows: 52
## Columns: 4
## $ GEOID   &lt;chr&gt; "01", "02", "04", "05", "06", "22", "21", "08", "09", "10", "…
## $ NAME    &lt;chr&gt; "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Lo…
## $ P001001 &lt;dbl&gt; 4.8e+06, 7.1e+05, 6.4e+06, 2.9e+06, 3.7e+07, 4.5e+06, 4.3e+06…
## $ P002005 &lt;dbl&gt; 1957932, 241338, 651358, 1278329, 1880350, 1215567, 1806024, …</code></pre>
<p>Here, we created a tibble with states in the rows and total population (“P001001”) and rural population (“P002005”) in the columns. To plot the proportion of each state’s population is that lives in rural areas is now a simple application of <strong>tidyverse</strong> functions we know and love. First, let’s create a variable for rural population proportion and order the states by that variable:</p>
<div class="sourceCode" id="cb807"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">&lt;-</span> <span class="va">rural</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>state <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop_rural <span class="op">=</span> <span class="va">P002005</span><span class="op">/</span><span class="va">P001001</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">prop_rural</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Next, let’s plot this using <code>ggplot()</code>:</p>
<div class="sourceCode" id="cb808"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">prop_rural</span>, y <span class="op">=</span> <span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">ylab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Rural Population Proportion"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-723-1.png" width="100%"></div>
<p>This kind of plot is great if we want to visualize which states are the most rural and which states are the least. We see immediately that Maine and Vermont are very rural and that D.C. is entirely urban (as one expect, given that it is a city). But what if we wanted a sense of how the proportion of rural residents varied geographically? We could figure this out from a plot like the one above if we know something about U.S. geography. It would be so much easier, however, if we could see this information directly on a map of the United States. R makes this easy to do.</p>
</div>
<div id="conceptual-introduction-to-mapping" class="section level2 unnumbered">
<h2>Conceptual introduction to mapping<a class="anchor" aria-label="anchor" href="#conceptual-introduction-to-mapping"><i class="fas fa-link"></i></a>
</h2>
<p>There are two underlying important pieces of information for spatial data: the coordinates of the object and how the coordinates relate to a physical location on Earth, which is also known as a coordinate reference system or <strong>CRS</strong>.</p>
<p>The coordinates are familiar from geography. A CRS uses a three-dimensional model of the earth to define specific locations on the surface of the grid. An object can be defined in relation to longitude (East/West) and latitude (North/South).</p>
<p>Where this gets complicated is when attempting to create a projection. A projection is a translation of the three-dimensional grid onto a two-dimensional plane. The animation below demonstrates this process.</p>
<div class="inline-figure"><img src="other/images/projection_tween.gif" width="100%"></div>
<p>Thus, the CRS determines how a geometric object will look when displayed on your two-dimensional screen. As we will see, you usually don’t need to select a CRS when working with <strong>tidycensus</strong>, but it is good to know about the concept if you ever work with other spatial data.</p>
<div id="vector-versus-spatial-data" class="section level3 unnumbered">
<h3>Vector versus spatial data<a class="anchor" aria-label="anchor" href="#vector-versus-spatial-data"><i class="fas fa-link"></i></a>
</h3>
<p>Spatial data with a defined CRS can either be vector or raster data. Vector data is based on points that can be connected to form lines and polygons. It is located within a <em>coordinate reference system.</em> An example is a road map.</p>
<p>Raster data, however, are values within a <em>grid system,</em> such as satellite imagery. In this book, we will only be dealing with vector data, which is the format in which we get data from the <strong>tidycensus</strong> package.</p>
</div>
<div id="sf-vs-sp" class="section level3 unnumbered">
<h3>
<strong>sf</strong> vs <strong>sp</strong><a class="anchor" aria-label="anchor" href="#sf-vs-sp"><i class="fas fa-link"></i></a>
</h3>
<p>An older package, <strong>sp</strong>, lets a user handle both vector and raster data. This book will focus on vector data and the <strong>sf</strong> package. The main differences between the <strong>sp</strong> and <strong>sf</strong> packages are how they store CRS information. While <strong>sp</strong> uses spatial sub classes, <strong>sf</strong> stores data in data frames, allowing it to interact with <strong>dplyr</strong> methods we’ve learned so far.</p>
</div>
<div id="shapefiles" class="section level3 unnumbered">
<h3>Shapefiles<a class="anchor" aria-label="anchor" href="#shapefiles"><i class="fas fa-link"></i></a>
</h3>
<p>R can handle importing different kinds of file formats for spatial data, including KML and geojson. We’ll focus on shapefiles, which were created by Esri in the 1990s. Though we refer to a “shapefile” in the singular, it’s actually a collection of at least three basic files:</p>
<ul>
<li>.shp - lists shape and vertices</li>
<li>.shx - has index with offsets</li>
<li>.dbf - relationship file between geometry and attributes (data)</li>
</ul>
<p>All files must be present in the directory and named the same (except for the file extension) to import correctly. Thankfully, <strong>tidycensus</strong> will grab the geometric information from the Census shapefile for you.</p>
</div>
</div>
<div id="mapping-with-tidycensus-and-geom_sf" class="section level2 unnumbered">
<h2>Mapping with <strong>tidycensus</strong> and <code>geom_sf()</code><a class="anchor" aria-label="anchor" href="#mapping-with-tidycensus-and-geom_sf"><i class="fas fa-link"></i></a>
</h2>
<p>In order to start mapping in R, we need to get a little more data from the <strong>tidycensus</strong> package. We can use the same <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code> function as before, this time adding the argument <code>geometry = TRUE</code>.</p>
<div class="sourceCode" id="cb809"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial</a></span><span class="op">(</span>geography <span class="op">=</span> <span class="st">"state"</span>,
                       variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"P001001"</span>, <span class="st">"P002005"</span><span class="op">)</span>,
                       year <span class="op">=</span> <span class="fl">2010</span>,
                       output <span class="op">=</span> <span class="st">"wide"</span>,
                       geometry <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>state <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop_rural <span class="op">=</span> <span class="va">P002005</span><span class="op">/</span><span class="va">P001001</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">prop_rural</span><span class="op">)</span><span class="op">)</span>

<span class="fu">glimpse</span><span class="op">(</span><span class="va">rural</span><span class="op">)</span></code></pre></div>
<pre><code>## Rows: 52
## Columns: 6
## $ GEOID      &lt;chr&gt; "01", "02", "04", "05", "06", "22", "21", "08", "09", "10"…
## $ state      &lt;fct&gt; Alabama, Alaska, Arizona, Arkansas, California, Louisiana,…
## $ P001001    &lt;dbl&gt; 4.8e+06, 7.1e+05, 6.4e+06, 2.9e+06, 3.7e+07, 4.5e+06, 4.3e…
## $ P002005    &lt;dbl&gt; 1957932, 241338, 651358, 1278329, 1880350, 1215567, 180602…
## $ geometry   &lt;MULTIPOLYGON [°]&gt; MULTIPOLYGON (((-85 31, -85..., MULTIPOLYGON …
## $ prop_rural &lt;dbl&gt; 0.410, 0.340, 0.102, 0.438, 0.050, 0.268, 0.416, 0.138, 0.…</code></pre>
<p>This is just like the tibble we had before, except now we have this funky “multipolygon” called <code>geometry</code>.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;If you run &lt;code&gt;typeof(rural$geometry)&lt;/code&gt;, you’ll see that this is just a kind of list, and thus &lt;code&gt;geometry&lt;/code&gt; is a list column.&lt;/p&gt;"><sup>9</sup></a> The <code>geometry</code> column contains all the information <code>ggplot()</code> needs to create a map.</p>
<p>In order to create a map using <code>ggplot()</code>, we need a new geom: <code>geom_sf()</code>. This works much like the geoms we have seen before, such as <code>geom_point()</code> and <code>geom_line()</code>, except this works with spatial data. Let’s see what happens if we run <code>geom_sf()</code> with no arguments:</p>
<div class="sourceCode" id="cb811"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-727-1.png" width="100%"></div>
<p>Well, that’s interesting. We have the boundaries of each state, including Alaska and Hawaii. But there are some problems. <strong>ggplot2</strong> is doing its best to fit everything on one image, which is taxing on the system. We can’t see any particular state very well, because the map is zoomed far out. Also, there are no colors because we didn’t fill it with our data.</p>
<p>So, let’s create a new map with <code>geom_sf()</code> and fill it with <code>prop_rural</code>. And we’ll filter out Alaska, Hawaii, and Puerto Rico for now.</p>
<div class="sourceCode" id="cb812"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="va">state</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alaska"</span>, <span class="st">"Hawaii"</span>, <span class="st">"Puerto Rico"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">prop_rural</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-728-1.png" width="100%"></div>
<p>Now we have something usable! This already has a lot of what we’d want from a map—most notably, the states are shaded based on our variable of interest, helping us to see some patterns in the data. But it could use a bit of a makeover, which we’ll give it in the next section.</p>
<div id="making-maps-pretty" class="section level3 unnumbered">
<h3>Making maps pretty<a class="anchor" aria-label="anchor" href="#making-maps-pretty"><i class="fas fa-link"></i></a>
</h3>
<p>There are a few ways we can aesthetically improve this map:</p>
<ul>
<li>Make the fill colors easier to distinguish</li>
<li>Make it so that darker colors map onto higher values of <code>prop_rural</code>
</li>
<li>Remove the gray background</li>
<li>Give the legend an informative title and add a title and caption</li>
</ul>
<p>A great function for providing the fill colors for maps is <code>scale_fill_viridis_c()</code>. This has a few different color palettes that can be selected with the <code>option</code> argument, all of which are easily distinguishable both when displayed in black and white and for people with common forms of colorblindness. You can also reverse the default order of the colors with the <code>direction = -1</code> option. This function is for continuous variables such as <code>prop_rural</code>; if you have a discrete variable, you can use the analogous <code>scale_fill_viridis_d()</code>.</p>
<p>We’ll also use <code>theme_void()</code>, a great theme for maps that gets rid of the gray background. Finally, we’ll use <code>labs()</code> to give the legend the title “Percent Rural” (and multiply the values of the variable by 100) and add an overall title and caption.</p>
<div class="sourceCode" id="cb813"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="va">state</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alaska"</span>, <span class="st">"Hawaii"</span>, <span class="st">"Puerto Rico"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">prop_rural</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span>,
                       direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Rural geography of the United States"</span>,
       caption <span class="op">=</span> <span class="st">"Source: Census 2010"</span>,
       fill <span class="op">=</span> <span class="st">"Percent Rural"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-729-1.png" width="100%"></div>
<p>With this map, it is clear that the more rural states are concentrated in the Great Plains, the South, and parts of New England, while the (South)west and Northeast are less rural.</p>
</div>
<div id="adding-back-alaska-and-hawaii" class="section level3 unnumbered">
<h3>Adding back Alaska and Hawaii<a class="anchor" aria-label="anchor" href="#adding-back-alaska-and-hawaii"><i class="fas fa-link"></i></a>
</h3>
<p>But what about Alaska and Hawaii? If you want to display those on your map without having to zoom out, you can take advantage of an argument in <code><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial()</a></code>, <code>shift_geo = TRUE</code>:</p>
<div class="sourceCode" id="cb814"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural_shifted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_decennial.html">get_decennial</a></span><span class="op">(</span>geography <span class="op">=</span> <span class="st">"state"</span>,
                               variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"P001001"</span>, <span class="st">"P002005"</span><span class="op">)</span>,
                               year <span class="op">=</span> <span class="fl">2010</span>,
                               output <span class="op">=</span> <span class="st">"wide"</span>,
                               geometry <span class="op">=</span> <span class="cn">TRUE</span>,
                               shift_geo <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>state <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop_rural <span class="op">=</span> <span class="va">P002005</span><span class="op">/</span><span class="va">P001001</span>,
         state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">prop_rural</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb815"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rural_shifted</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">prop_rural</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span>,
                       direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Rural geography of the United States"</span>,
       caption <span class="op">=</span> <span class="st">"Source: Census 2010"</span>,
       fill <span class="op">=</span> <span class="st">"Percent Rural"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-731-1.png" width="100%"></div>
<p>Now, Alaska and Hawaii can be displayed near the lower 48 states. Note that this option removes Puerto Rico from your tibble altogether, so this is not a good option if you want to show data from Puerto Rico.</p>
</div>
</div>
<div id="faceting-maps" class="section level2 unnumbered">
<h2>Faceting maps<a class="anchor" aria-label="anchor" href="#faceting-maps"><i class="fas fa-link"></i></a>
</h2>
<p>A powerful tool in <strong>ggplot2</strong> to use with maps is faceting. Let’s grab data from the ACS on the population in Harris County, Texas census tracts by race:</p>
<div class="sourceCode" id="cb816"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">racevars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>White <span class="op">=</span> <span class="st">"B02001_002"</span>, 
              Black <span class="op">=</span> <span class="st">"B02001_003"</span>, 
              Asian <span class="op">=</span> <span class="st">"B02001_005"</span>,
              Hispanic <span class="op">=</span> <span class="st">"B03003_003"</span><span class="op">)</span>
<span class="va">harris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidycensus/man/get_acs.html">get_acs</a></span><span class="op">(</span>geography <span class="op">=</span> <span class="st">"tract"</span>,
                  variables <span class="op">=</span> <span class="va">racevars</span>, 
                  year <span class="op">=</span> <span class="fl">2018</span>,
                  state <span class="op">=</span> <span class="st">"TX"</span>,
                  county <span class="op">=</span> <span class="st">"Harris County"</span>,
                  geometry <span class="op">=</span> <span class="cn">TRUE</span>,
                  summary_var <span class="op">=</span> <span class="st">"B02001_001"</span><span class="op">)</span> </code></pre></div>
<p>This code is very similar to what we’ve used before, except here we are retrieving the data from the American Community Survey using <code><a href="https://rdrr.io/pkg/tidycensus/man/get_acs.html">get_acs()</a></code> instead of from the decennial census. Some new features worth pointing out:</p>
<ul>
<li>The <code>year</code> for <code><a href="https://rdrr.io/pkg/tidycensus/man/get_acs.html">get_acs()</a></code> is the last year of a five year sample. Thus, our data will be from 2014–2018. You can choose <code>year</code>s from 2009–2018.</li>
<li>Since our geography is “tract,” we are further specifying the <code>state</code> and <code>county</code>.</li>
<li>We are obtaining the data in a long format, which makes faceting easier.</li>
<li>We added a <code>summary_var</code>, “B02001_001,” which is the total population. As we’ll see, this appears as a separate column, which is helpful to us. (As an exercise, try going back to the code that created <code>rural</code> and see how you would do that in a long format with <code>summary_var</code>.)</li>
</ul>
<p>Let’s take a look at <code>harris</code>:</p>
<div class="sourceCode" id="cb817"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">glimpse</span><span class="op">(</span><span class="va">harris</span><span class="op">)</span></code></pre></div>
<pre><code>## Rows: 3,144
## Columns: 8
## $ GEOID       &lt;chr&gt; "48201100000", "48201100000", "48201100000", "48201100000…
## $ NAME        &lt;chr&gt; "Census Tract 1000, Harris County, Texas", "Census Tract …
## $ variable    &lt;chr&gt; "White", "Black", "Asian", "Hispanic", "White", "Black", …
## $ estimate    &lt;dbl&gt; 3426, 1045, 230, 892, 2936, 3591, 7, 2119, 2973, 885, 0, …
## $ moe         &lt;dbl&gt; 390, 308, 106, 241, 1358, 2196, 14, 1013, 430, 242, 13, 4…
## $ summary_est &lt;dbl&gt; 5063, 5063, 5063, 5063, 6820, 6820, 6820, 6820, 4403, 440…
## $ summary_moe &lt;dbl&gt; 478, 478, 478, 478, 3685, 3685, 3685, 3685, 502, 502, 502…
## $ geometry    &lt;MULTIPOLYGON [°]&gt; MULTIPOLYGON (((-95 30, -95..., MULTIPOLYGON…</code></pre>
<p>These are similar to what we’ve seen before. Note that we now have <code>moe</code> and <code>summary_moe</code> columns, which stand for “margin of error.” This is because, unlike the decennial census, the ACS is a survey and thus the values we get are estimates of the true value.<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Even the decennial census, of course, is an estimate, given the possibility of nonresponse and other errors, but it is closer to the true value than a survey.&lt;/p&gt;"><sup>10</sup></a></p>
<div id="transforming-and-mapping-the-data" class="section level3 unnumbered">
<h3>Transforming and mapping the data<a class="anchor" aria-label="anchor" href="#transforming-and-mapping-the-data"><i class="fas fa-link"></i></a>
</h3>
<p>Now we can use <code>facet_wrap()</code> to look at our race variables side-by-side:</p>
<div class="sourceCode" id="cb819"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">harris</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Percent <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">estimate</span> <span class="op">/</span> <span class="va">summary_est</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Percent</span>, color <span class="op">=</span> <span class="va">Percent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">variable</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span>direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_viridis_c</span><span class="op">(</span>direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Racial geography of Harris County, Texas"</span>,
       caption <span class="op">=</span> <span class="st">"Source: American Community Survey 2014-2018"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="book_temp_files/figure-html/unnamed-chunk-735-1.png" width="100%"></div>
<p>Note how easy it was to create the percentages using <code>summary_est</code>. We also used <code>color = Percent</code> and <code>scale_color_viridis_c()</code> to avoid having annoying borders around each of the census tracts. Otherwise, this doesn’t differ much from our code before, yet it is much easier to make comparisons across variables. Faceting is a powerful tool to use with maps.</p>
</div>
</div>
<div id="want-to-explore-further" class="section level2 unnumbered">
<h2>Want to explore further?<a class="anchor" aria-label="anchor" href="#want-to-explore-further"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>Take a look at the <a href="https://walkerke.github.io/tidycensus/"><strong>tidycensus</strong> website</a>.</li>
<li>If you have shapefiles from a place other than <strong>tidycensus</strong>, you can read them in using <code>st_read()</code> in the <strong>sf</strong> package, join them with other data using <strong>dplyr</strong> functions, and then map them with <code>geom_sf()</code> as we have shown above.
<ul>
<li>You may have to look into using <a href="https://ggplot2.tidyverse.org/reference/ggsf.html"><code>coord_sf()</code></a> if you have trouble displaying your data.</li>
</ul>
</li>
<li>Want to add interactivity to your maps? Check out the <strong>leaflet</strong> package. <a href="https://juliasilge.com/blog/using-tidycensus/">Here’s</a> a good introduction to using <strong>leaflet</strong> with <strong>tidycensus</strong>.</li>
<li>Practice your skills with <a href="https://andrewbtran.github.io/NICAR/2019/mapping/02_case_study_slides.html">Andrew Tran’s case study slides</a>, where you can replicate a graphic from the Washington Post. Note: this involves some packages we haven’t shown you in this book, but if you follow along step by step you will be able to see how they are used.</li>
</ul>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="shiny.html">Shiny</a></div>
<div class="next"><a href="animation.html">Animation</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#maps">Maps</a></li>
<li><a class="nav-link" href="#tidycensus">Tidycensus</a></li>
<li>
<a class="nav-link" href="#conceptual-introduction-to-mapping">Conceptual introduction to mapping</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#vector-versus-spatial-data">Vector versus spatial data</a></li>
<li><a class="nav-link" href="#sf-vs-sp">sf vs sp</a></li>
<li><a class="nav-link" href="#shapefiles">Shapefiles</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#mapping-with-tidycensus-and-geom_sf">Mapping with tidycensus and geom_sf()</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#making-maps-pretty">Making maps pretty</a></li>
<li><a class="nav-link" href="#adding-back-alaska-and-hawaii">Adding back Alaska and Hawaii</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#faceting-maps">Faceting maps</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#transforming-and-mapping-the-data">Transforming and mapping the data</a></li></ul>
</li>
<li><a class="nav-link" href="#want-to-explore-further">Want to explore further?</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/PPBDS/primer/blob/master/maps.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/PPBDS/primer/edit/master/maps.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Preceptor’s Primer for Bayesian Big Data Science</strong>" was written by David Kane. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
